# Database Diagram - Tourism Booking System

## Database Architecture Overview
**Database Type:** Firebase Firestore (NoSQL Document Database)

---

## Collections Structure

### 1. **Users Collection** (`users`)
```
┌─────────────────────────────────────────────────────────────┐
│                         USERS                                │
├─────────────────────────────────────────────────────────────┤
│ Document ID: uid (Auto-generated by Firebase Auth)          │
├─────────────────────────────────────────────────────────────┤
│ Fields:                                                      │
│  • uid              : String (Primary Key)                   │
│  • email            : String (Unique, Indexed)               │
│  • password         : String (Hashed - Firebase Auth)        │
│  • firstName        : String                                 │
│  • lastName         : String                                 │
│  • role             : String (enum: 'admin', 'user')         │
│  • isActive         : Boolean (default: true)                │
│  • createdAt        : Timestamp                              │
│  • updatedAt        : Timestamp                              │
│  • lastLogin        : Timestamp                              │
│  • createdBy        : String (uid of admin who created)      │
└─────────────────────────────────────────────────────────────┘
```

**Indexes:**
- `email` (Unique)
- `role` (For filtering admin/user)
- `createdAt` (For sorting)

---

### 2. **Bookings Collection** (`bookings`)
```
┌─────────────────────────────────────────────────────────────┐
│                        BOOKINGS                              │
├─────────────────────────────────────────────────────────────┤
│ Document ID: Auto-generated ID                              │
├─────────────────────────────────────────────────────────────┤
│ Fields:                                                      │
│  • id               : String (Document ID)                   │
│  • userId           : String (Foreign Key → users.uid)       │
│  • name             : String                                 │
│  • email            : String                                 │
│  • phone            : String                                 │
│  • place            : String (Destination name)              │
│  • hotel            : String                                 │
│  • arrivalDate      : String (Date format)                   │
│  • departureDate    : String (Date format)                   │
│  • guests           : Number                                 │
│  • status           : String (enum: pending/confirmed/       │
│                       cancelled/completed)                   │
│  • created          : Timestamp                              │
│  • updated          : Timestamp                              │
│  • updatedBy        : String (email of admin)                │
└─────────────────────────────────────────────────────────────┘
```

**Indexes:**
- `userId` (For user's bookings query)
- `status` (For filtering by status)
- `created` (For sorting by date)
- Compound Index: `status + created` (For admin queries)

---

## Entity Relationships

```
┌──────────────┐                      ┌──────────────┐
│    USERS     │                      │   BOOKINGS   │
│              │                      │              │
│  uid (PK)    │──────────────────────│  userId (FK) │
│  email       │    1           *     │  id (PK)     │
│  role        │                      │  status      │
│  isActive    │                      │  created     │
│  createdAt   │                      │  updated     │
└──────────────┘                      └──────────────┘
       │                                     │
       │ 1                                   │
       │                                     │
       │ *                                   │ 1
       │                                     │
┌──────────────┐                      ┌──────────────┐
│ Created By   │                      │  Updated By  │
│ (Admin Users)│                      │  (Admin)     │
└──────────────┘                      └──────────────┘
```

**Relationship Types:**
- **Users → Bookings**: One-to-Many (One user can have multiple bookings)
- **Admin → Users**: One-to-Many (One admin can create multiple users)
- **Admin → Bookings**: Many-to-Many (Admins can update any booking)

---

## Data Access Patterns

### User Queries:
```sql
# Get user by email
users.where('email', '==', email)

# Get user by UID
users.doc(uid)

# Get all users (Admin only)
users.get()

# Filter by role
users.where('role', '==', 'admin')

# Filter by status
users.where('isActive', '==', true)
```

### Booking Queries:
```sql
# Get user's bookings
bookings.where('userId', '==', uid).orderBy('created', 'desc')

# Get all bookings (Admin)
bookings.orderBy('created', 'desc')

# Filter by status
bookings.where('status', '==', 'pending')

# Search by fields (in-memory filter)
bookings.get() → filter(name/email/place/hotel contains search)
```

---

## Security Rules (Firebase)

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection
    match /users/{userId} {
      // Users can read their own data
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Only admins can read all users
      allow read: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // Only admins can create/update/delete users
      allow write: if request.auth != null && 
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Bookings collection
    match /bookings/{bookingId} {
      // Users can read their own bookings
      allow read: if request.auth != null && 
                     (resource.data.userId == request.auth.uid ||
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
      
      // Users can create bookings
      allow create: if request.auth != null && 
                       request.resource.data.userId == request.auth.uid;
      
      // Only admins can update/delete bookings
      allow update, delete: if request.auth != null && 
                               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
```

---

## Authentication Flow

```
┌─────────────┐
│ Firebase    │
│ Auth        │
└──────┬──────┘
       │
       │ Manages
       │
       ▼
┌─────────────────────────────────┐
│ Authentication Tokens (JWT)     │
├─────────────────────────────────┤
│  • uid (User ID)                │
│  • email                        │
│  • email_verified               │
│  • iat (Issued At)              │
│  • exp (Expiration - 24 hours)  │
│  • Custom Claims:               │
│    - role (admin/user)          │
└─────────────────────────────────┘
```

---

## Storage Considerations

### Current Implementation:
- **Primary Storage**: Firebase Firestore
- **Authentication**: Firebase Authentication
- **File Storage**: Not implemented (future: Firebase Storage for images)

### Scalability:
- Firestore supports up to 1 million concurrent connections
- Document size limit: 1 MB
- Collection depth limit: 100 levels
- Automatic scaling and load balancing

### Backup Strategy:
- Firebase provides automatic daily backups
- Manual exports available via Firebase Console
- Export format: JSON/CSV

---

## Data Flow Summary

```
┌─────────┐    Authentication    ┌──────────────┐
│ Client  │◄────────────────────►│ Firebase     │
│ (React) │                      │ Auth         │
└────┬────┘                      └──────────────┘
     │                                  │
     │                                  │ Verifies Token
     │                                  ▼
     │ API Requests            ┌──────────────┐
     │ (JWT Token)             │ Express.js   │
     └────────────────────────►│ Backend API  │
                               └──────┬───────┘
                                      │
                                      │ CRUD Operations
                                      ▼
                               ┌──────────────┐
                               │ Firebase     │
                               │ Firestore    │
                               │ (Database)   │
                               └──────────────┘
```

---

## Key Points:
1. **NoSQL Structure**: Flexible schema, document-based
2. **Real-time Sync**: Firestore provides real-time updates
3. **Security**: Rules-based access control
4. **Indexing**: Automatic and manual indexes for performance
5. **Relationships**: Managed through document references (userId, createdBy)
